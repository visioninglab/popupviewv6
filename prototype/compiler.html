<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Compile + Resize</title>
  <style>
    body { font-family: system-ui; max-width: 600px; margin: 40px auto; padding: 0 20px; background: #1a1a2e; color: #e0e0e0; }
    h1 { color: #00d4ff; }
    button { background: #00d4ff; color: #1a1a2e; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold; margin: 5px 0; display: block; }
    button:disabled { background: #555; }
    #log { background: #16213e; padding: 16px; border-radius: 8px; white-space: pre-wrap; font-size: 13px; min-height: 100px; }
    .ok { color: #0f8; } .err { color: #f44; }
    img { max-width: 200px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>PopupView â€” Build Assets</h1>
  <p>Run this on desktop Chrome to compile the trigger target and resize the texture.</p>

  <h3>Trigger Image</h3>
  <img src="assets/trigger.png">

  <h3>Bug Texture (original: 6.8MB)</h3>
  <img src="assets/bug-texture.png" style="max-width:150px">

  <br><br>
  <button onclick="runAll()">Build All Assets</button>
  <pre id="log">Ready. Click "Build All Assets" to start.</pre>

  <script>
    const log = document.getElementById('log');
    function msg(text, cls) { log.innerHTML += `<span class="${cls||''}">${text}</span>\n`; }

    async function runAll() {
      log.innerHTML = '';

      // Step 1: Resize bug texture to ~500px JPEG
      msg('=== Resizing bug texture ===');
      try {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        await new Promise((r, e) => { img.onload = r; img.onerror = e; img.src = 'assets/bug-texture.png'; });
        msg('Original: ' + img.width + 'x' + img.height);

        const size = 512;
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, size, size);

        const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.85));
        msg('Resized: ' + size + 'x' + size + ' (' + (blob.size/1024).toFixed(0) + 'KB)', 'ok');

        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'bug-texture-small.jpg';
        a.click();
        msg('Downloaded: bug-texture-small.jpg', 'ok');
      } catch(e) {
        msg('Resize error: ' + e.message, 'err');
      }

      // Step 2: Compile trigger image to .mind
      msg('\n=== Compiling trigger target ===');
      msg('Loading MindAR compiler...');
      try {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js';
        await new Promise((r, e) => { script.onload = r; script.onerror = e; document.head.appendChild(script); });
        msg('MindAR loaded', 'ok');

        // Check what's available globally
        msg('window.MINDAR: ' + (typeof window.MINDAR));
        msg('Available globals: ' + Object.keys(window).filter(k => k.toLowerCase().includes('mind')).join(', '));

        const Compiler = window.MINDAR?.IMAGE?.MindARImageCompiler
          || window.MindARImageCompiler
          || (window.MINDAR?.IMAGE && Object.values(window.MINDAR.IMAGE).find(v => typeof v === 'function'));

        if (!Compiler) {
          msg('Compiler class not found. Checking MINDAR object...', 'err');
          if (window.MINDAR) {
            msg('MINDAR keys: ' + JSON.stringify(Object.keys(window.MINDAR)));
            if (window.MINDAR.IMAGE) {
              msg('MINDAR.IMAGE keys: ' + JSON.stringify(Object.keys(window.MINDAR.IMAGE)));
            }
          }
          return;
        }

        msg('Compiler found!', 'ok');

        const triggerImg = new Image();
        triggerImg.crossOrigin = 'anonymous';
        await new Promise((r, e) => { triggerImg.onload = r; triggerImg.onerror = e; triggerImg.src = 'assets/trigger.png'; });
        msg('Trigger image loaded: ' + triggerImg.width + 'x' + triggerImg.height);

        msg('Compiling (30-60 seconds)...');
        const compiler = new Compiler();
        await compiler.compileImageTargets([triggerImg], (p) => {
          const pct = Math.round(p);
          log.lastElementChild.textContent = 'Progress: ' + pct + '%';
        });
        msg('');

        const buffer = await compiler.exportData();
        msg('Compiled! Size: ' + (buffer.byteLength/1024).toFixed(0) + 'KB', 'ok');

        const b = new Blob([buffer], { type: 'application/octet-stream' });
        const a2 = document.createElement('a');
        a2.href = URL.createObjectURL(b);
        a2.download = 'targets.mind';
        a2.click();
        msg('Downloaded: targets.mind', 'ok');

        msg('\n=== DONE ===', 'ok');
        msg('Move both files to prototype/assets/ and push to GitHub.', 'ok');
      } catch(e) {
        msg('Compiler error: ' + e.message, 'err');
        msg(e.stack, 'err');
      }
    }
  </script>
</body>
</html>
